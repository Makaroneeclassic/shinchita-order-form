<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>บันทึกออเดอร์ Shinchita</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f7f7f8;--card:#fff;--text:#111;--muted:#6b7280;--line:#e5e7eb;--primary:#3b82f6;}
    *{box-sizing:border-box}
    body{font-family:'Kanit',system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text);margin:0}
    .wrap{max-width:920px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.03);padding:18px 16px;margin:14px 0}
    h1{font-size:22px;margin:14px 0 8px}
    h2{font-size:18px;margin:0 0 8px}
    h3{font-size:16px;margin:10px 0 6px}
    label{display:block;font-size:14px;margin:6px 0 4px}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
    textarea{resize:vertical}
    .row{display:grid;gap:12px}
    .row-2{grid-template-columns:1fr 1fr}
    .row-3{grid-template-columns:1fr 1fr 1fr}
    .muted{color:var(--muted);font-size:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 16px;font-weight:600}
    .primary{background:#111;color:#fff}
    .secondary{background:var(--primary);color:#fff}
    .ghost{background:#fff;border:1px solid var(--line)}
    .bar{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;margin-right:6px;font-size:12px;color:#374151}
    .ok{color:#16a34a}
    .err{color:#b91c1c}
    .total{font-weight:600}
    .badge{background:#111;color:#fff;border-radius:999px;padding:2px 8px;margin-left:8px;font-size:12px}
    .autofill-card{background:#eff6ff;border:2px dashed var(--primary)}
    @media (max-width:720px){.row-2,.row-3{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <h1>บันทึกออเดอร์ <span class="badge">Production</span></h1>
  <div class="card">
    <div class="muted">คำแนะนำ: กรอกข้อมูลให้ครบ แล้วกด "ส่งออเดอร์" ระบบจะบันทึกลง Google Sheet ให้เอง</div>
  </div>

  <!-- Auto-fill Card -->
  <div class="card autofill-card">
    <h2>✨ วางข้อมูลเพื่อกรอกอัตโนมัติ</h2>
    <label>วางข้อความที่คัดลอกมาในช่องนี้ (รองรับหลายรูปแบบ)</label>
    <textarea id="autofillInput" rows="10" placeholder="ตัวอย่าง:
ชุบแป้งทอด คละรส 20
หรือ
ชุบแป้งทอด
คละรส 20"></textarea>
    <div class="bar">
      <button type="button" class="btn secondary" id="btnAutofill">กรอกอัตโนมัติ</button>
      <button type="button" class="btn ghost" id="btnClearAutofill">ล้างช่อง</button>
    </div>
    <div id="autofillMsg" style="margin-top:10px"></div>
  </div>

  <form id="f" class="card">
    <h2>ข้อมูลลูกค้า</h2>
    <div class="row row-2">
      <div><label>ชื่อ</label><input name="first_name" id="first_name" required></div>
      <div><label>นามสกุล</label><input name="last_name" id="last_name" required></div>
    </div>
    <label>ที่อยู่</label>
    <textarea name="address" id="address" rows="2" required></textarea>
    <div class="row row-2">
      <div>
        <label>เบอร์โทร</label>
        <input name="phone" id="phone" placeholder="0891234567" required>
        <div class="muted">ระบบจะใช้เป็น Primary ID (เก็บเฉพาะตัวเลขอัตโนมัติ)</div>
      </div>
      <div>
        <label>ยอดเงิน (บาท)</label>
        <input name="amount" id="amount" type="number" step="0.01" min="0" required>
      </div>
    </div>
    <div class="row row-2">
      <div>
        <label>วิธีชำระ</label>
        <select name="payment_method" id="payment_method">
          <option value="TRANSFER">โอน</option>
          <option value="COD">COD</option>
        </select>
      </div>
      <div>
        <label>ขนส่ง</label>
        <input name="shipping" id="shipping" placeholder="เช่น ไปรษณีย์, Kerry, Flash">
      </div>
    </div>
    <div class="row row-2">
      <div>
        <label>Social Media</label>
        <div style="display:flex;gap:8px;margin-bottom:4px">
          <label style="display:inline-flex;align-items:center;cursor:pointer">
            <input type="radio" name="social_type" value="LINE" id="social_line" checked style="width:auto;margin-right:4px">
            <span>LINE</span>
          </label>
          <label style="display:inline-flex;align-items:center;cursor:pointer">
            <input type="radio" name="social_type" value="FB" id="social_fb" style="width:auto;margin-right:4px">
            <span>Facebook</span>
          </label>
        </div>
        <input name="social_name" id="social_name" placeholder="ชื่อบัญชี Social Media">
      </div>
      <div>
        <label>หมายเหตุ (ถ้ามี)</label>
        <input name="note" id="note" placeholder="เช่น ส่งด่วน/เก็บเงินปลายทาง">
      </div>
    </div>

    <hr style="border:0;border-top:1px solid var(--line);margin:14px 0">

    <h2>สินค้าและรสชาติ (กรอกจำนวนห่อ)</h2>

    <!-- ROLL -->
    <h3>สาหร่ายม้วน (roll)</h3>
    <!-- รสปกติ -->
    <div class="grid3">
      <div><label>ดั้งเดิม</label><input type="number" min="0" value="0" data-ptype="roll" data-flavor="ดั้งเดิม" id="roll-ดั้งเดิม"></div>
      <div><label>เผ็ด</label><input type="number" min="0" value="0" data-ptype="roll" data-flavor="เผ็ด" id="roll-เผ็ด"></div>
      <div><label>บาร์บีคิว</label><input type="number" min="0" value="0" data-ptype="roll" data-flavor="บาร์บีคิว" id="roll-บาร์บีคิว"></div>
    </div>
    <div class="grid3">
      <div><label>ปลาหมึก</label><input type="number" min="0" value="0" data-ptype="roll" data-flavor="ปลาหมึก" id="roll-ปลาหมึก"></div>
      <div><label>หม่าล่า</label><input type="number" min="0" value="0" data-ptype="roll" data-flavor="หม่าล่า" id="roll-หม่าล่า"></div>
      <div><label>ต้มยำ</label><input type="number" min="0" value="0" data-ptype="roll" data-flavor="ต้มยำ" id="roll-ต้มยำ"></div>
    </div>
    <div class="grid3">
      <div><label>วาซาบิ</label><input type="number" min="0" value="0" data-ptype="roll" data-flavor="วาซาบิ" id="roll-วาซาบิ"></div>
      <div><label>ชีส</label><input type="number" min="0" value="0" data-ptype="roll" data-flavor="ชีส" id="roll-ชีส"></div>
      <div><label>คอร์นชีส</label><input type="number" min="0" value="0" data-ptype="roll" data-flavor="คอร์นชีส" id="roll-คอร์นชีส"></div>
    </div>
    <div class="grid3">
      <div><label>หม่าล่า เจ</label><input type="number" min="0" value="0" data-ptype="roll" data-flavor="หม่าล่า เจ" id="roll-หม่าล่า เจ"></div>
      <div><label>วาซาบิ เจ</label><input type="number" min="0" value="0" data-ptype="roll" data-flavor="วาซาบิ เจ" id="roll-วาซาบิ เจ"></div>
      <div><label>คละรส</label><input type="number" min="0" value="0" data-ptype="roll" data-flavor="คละรส" id="roll-คละรส"></div>
    </div>
    </div>

    <!-- FRIED -->
    <h3>สาหร่ายทอดกรอบ (fried)</h3>
    <!-- รสปกติ -->
    <div class="grid3">
      <div><label>ดั้งเดิม</label><input type="number" min="0" value="0" data-ptype="fried" data-flavor="ดั้งเดิม" id="fried-ดั้งเดิม"></div>
      <div><label>เผ็ด</label><input type="number" min="0" value="0" data-ptype="fried" data-flavor="เผ็ด" id="fried-เผ็ด"></div>
      <div><label>บาร์บีคิว</label><input type="number" min="0" value="0" data-ptype="fried" data-flavor="บาร์บีคิว" id="fried-บาร์บีคิว"></div>
    </div>
    <div class="grid3">
      <div><label>ปาปริก้า</label><input type="number" min="0" value="0" data-ptype="fried" data-flavor="ปาปริก้า" id="fried-ปาปริก้า"></div>
      <div><label>หม่าล่า</label><input type="number" min="0" value="0" data-ptype="fried" data-flavor="หม่าล่า" id="fried-หม่าล่า"></div>
      <div><label>ต้มยำ</label><input type="number" min="0" value="0" data-ptype="fried" data-flavor="ต้มยำ" id="fried-ต้มยำ"></div>
    </div>
    <div class="grid3">
      <div><label>วาซาบิ</label><input type="number" min="0" value="0" data-ptype="fried" data-flavor="วาซาบิ" id="fried-วาซาบิ"></div>
      <div><label>ชีส</label><input type="number" min="0" value="0" data-ptype="fried" data-flavor="ชีส" id="fried-ชีส"></div>
      <div><label>คอร์นชีส</label><input type="number" min="0" value="0" data-ptype="fried" data-flavor="คอร์นชีส" id="fried-คอร์นชีส"></div>
      <div><label>คละรส</label><input type="number" min="0" value="0" data-ptype="fried" data-flavor="คละรส" id="fried-คละรส"></div>
    </div>

    <!-- BATTERED -->
    <h3>สาหร่ายชุปแป้งทอด (battered)</h3>
    <!-- รสปกติ -->
    <div class="grid3">
      <div><label>ดั้งเดิม</label><input type="number" min="0" value="0" data-ptype="battered" data-flavor="ดั้งเดิม" id="battered-ดั้งเดิม"></div>
      <div><label>เผ็ด</label><input type="number" min="0" value="0" data-ptype="battered" data-flavor="เผ็ด" id="battered-เผ็ด"></div>
      <div><label>บาร์บีคิว</label><input type="number" min="0" value="0" data-ptype="battered" data-flavor="บาร์บีคิว" id="battered-บาร์บีคิว"></div>
    </div>
    <div class="grid3">
      <div><label>ปาปริก้า</label><input type="number" min="0" value="0" data-ptype="battered" data-flavor="ปาปริก้า" id="battered-ปาปริก้า"></div>
      <div><label>หม่าล่า</label><input type="number" min="0" value="0" data-ptype="battered" data-flavor="หม่าล่า" id="battered-หม่าล่า"></div>
      <div><label>ต้มยำ</label><input type="number" min="0" value="0" data-ptype="battered" data-flavor="ต้มยำ" id="battered-ต้มยำ"></div>
    </div>
    <div class="grid3">
      <div><label>วาซาบิ</label><input type="number" min="0" value="0" data-ptype="battered" data-flavor="วาซาบิ" id="battered-วาซาบิ"></div>
      <div><label>ชีส</label><input type="number" min="0" value="0" data-ptype="battered" data-flavor="ชีส" id="battered-ชีส"></div>
      <div><label>คอร์นชีส</label><input type="number" min="0" value="0" data-ptype="battered" data-flavor="คอร์นชีส" id="battered-คอร์นชีส"></div>
    </div>
    <div class="grid3">
      <div><label>ดั้งเดิม เจ</label><input type="number" min="0" value="0" data-ptype="battered" data-flavor="ดั้งเดิม เจ" id="battered-ดั้งเดิม เจ"></div>
      <div><label>หม่าล่า เจ</label><input type="number" min="0" value="0" data-ptype="battered" data-flavor="หม่าล่า เจ" id="battered-หม่าล่า เจ"></div>
      <div><label>วาซาบิ เจ</label><input type="number" min="0" value="0" data-ptype="battered" data-flavor="วาซาบิ เจ" id="battered-วาซาบิ เจ"></div>
      <div><label>คละรส</label><input type="number" min="0" value="0" data-ptype="battered" data-flavor="คละรส" id="battered-คละรส"></div>
    </div>

    <div class="card" style="background:#fafafa;border-style:dashed">
      <div id="summary" class="muted">ยังไม่มียอดห่อ</div>
    </div>

    <div class="bar">
      <button type="button" class="btn ghost" id="btnClear">ล้างฟอร์ม</button>
      <button type="submit" class="btn primary" id="btnSubmit">ส่งออเดอร์</button>
    </div>

    <div id="msg" style="margin-top:10px"></div>
  </form>

  <div class="card">
    <h2>วิธีใช้งาน</h2>
    <ol>
      <li>เปิด n8n → เปิด Workflow ให้เป็น <b>Active</b></li>
      <li>คัดลอก <b>Production URL</b> ของ Webhook (<code>/webhook/order-intake</code>)</li>
      <li>นำไปแทนในตัวแปร <code>WEBHOOK_URL</code> ด้านล่างในสคริปต์</li>
      <li>เปิดไฟล์นี้ในเบราว์เซอร์ กรอก แล้วกด "ส่งออเดอร์"</li>
    </ol>
  </div>
</div>

<script>
/** 🔧 ตั้งค่า URL ของ Webhook (Production) ตรงนี้ */
const WEBHOOK_URL = "https://n8n.makaronee.com/webhook/order-intake";  // ← ใส่ของจริง

const form = document.getElementById('f');
const msg  = document.getElementById('msg');
const btnSubmit = document.getElementById('btnSubmit');
const summary = document.getElementById('summary');
const btnClear = document.getElementById('btnClear');
const autofillInput = document.getElementById('autofillInput');
const btnAutofill = document.getElementById('btnAutofill');
const btnClearAutofill = document.getElementById('btnClearAutofill');
const autofillMsg = document.getElementById('autofillMsg');

/** สรุปจำนวนห่อแบบเรียลไทม์ */
function updateSummary(){
  const inputs = Array.from(document.querySelectorAll('input[data-ptype]'));
  const items = inputs
    .map(el => ({ product_type: el.dataset.ptype, flavor: el.dataset.flavor, packs: Number(el.value || 0) } ))
    .filter(x => x.packs > 0);

  if(!items.length){ summary.innerHTML = 'ยังไม่มียอดห่อ'; return; }

  const total = items.reduce((s,x)=>s+x.packs,0);
  const lines = items.map(x=>`${x.product_type} – ${x.flavor}: ${x.packs} ห่อ`);
  summary.innerHTML = `<span class="total">รวม ${total} ห่อ</span><br>${lines.join('<br>')}`;
}
document.querySelectorAll('input[data-ptype]').forEach(el => el.addEventListener('input', updateSummary));
updateSummary();

btnClear.addEventListener('click', ()=>{
  form.reset();
  updateSummary();
  msg.innerHTML = '';
});
btnClearAutofill.addEventListener('click', ()=>{
  autofillInput.value = '';
  autofillMsg.innerHTML = '';
});

/** Auto-fill */
btnAutofill.addEventListener('click', ()=>{
  const text = autofillInput.value.trim();
  if(!text){
    autofillMsg.innerHTML = '<div class="err">โปรดวางข้อมูลก่อนกดกรอกอัตโนมัติ</div>';
    return;
  }
  autofillMsg.innerHTML = '<div class="muted">กำลังประมวลผล...</div>';
  try {
    const data = parseAutofillData(text);
    fillFormWithData(data);
    autofillMsg.innerHTML = `<div class="ok">กรอกข้อมูลสำเร็จ!</div>`;
    updateSummary();
  } catch(err) {
    autofillMsg.innerHTML = `<div class="err">เกิดข้อผิดพลาด: ${err.message}</div>`;
  }
});

/** ---------- Parser (ตัดมาเฉพาะส่วนที่เกี่ยวกับคละรส) ---------- */
function parseAutofillData(text) {
  const data = { flavors: {} };
  const lines = text.split('\n').map(l => l.trim()).filter(l => l);

  const productTypes = {
    'ชุบแป้งทอด': 'battered',
    'ชุปแป้งทอด': 'battered',
    'battered': 'battered',
    'ม้วน': 'roll',
    'roll': 'roll',
    'ทอด': 'fried',
    'fried': 'fried',
  };

  // เพิ่ม mapping "คละรส"
  const flavorKeywords = {
    'คละรส': { flavors: { roll: 'คละรส', fried: 'คละรส', battered: 'คละรส' } },
    // (รสอื่น ๆ ของคุณจะใส่ต่อได้ที่นี่เหมือนโค้ดเดิม)
  };

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i], lowerLine = line.toLowerCase();

    // ตรวจเจอหมวด
    let matchedType = null;
    for (const [keyword, ptype] of Object.entries(productTypes)) {
      if (lowerLine.includes(keyword)) { matchedType = ptype; break; }
    }
    if (matchedType) {
      // เคส 1: บรรทัดเดียว "ชุบแป้งทอด คละรส 20"
      const mixedInline = /คละรส\s*(\d+)\s*(?:ห่อ|pack|packs)?/i.exec(line);
      if (mixedInline) {
        const qty = parseInt(mixedInline[1]);
        if (qty > 0) {
          const key = `${matchedType}-คละรส`;
          data.flavors[key] = (data.flavors[key] || 0) + qty;
        }
        continue;
      }
      // เคส 2: บรรทัดถัดไป "คละรส 20"
      const next = lines[i+1] || '';
      const mixedNext = /คละรส\s*(\d+)\s*(?:ห่อ|pack|packs)?/i.exec(next);
      if (mixedNext) {
        const qty = parseInt(mixedNext[1]);
        if (qty > 0) {
          const key = `${matchedType}-คละรส`;
          data.flavors[key] = (data.flavors[key] || 0) + qty;
        }
        i += 1; // ข้ามบรรทัดถัดไปแล้ว
        continue;
      }
    }
  }

  return data;
}

/** เติมค่าลงฟอร์ม */
function fillFormWithData(data) {
  // flavors → ใส่ตรง id เลย
  if (data.flavors) {
    Object.entries(data.flavors).forEach(([key, qty])=>{
      const el = document.getElementById(key);
      if (el) el.value = qty;
    });
  }
}

/** ส่งข้อมูลไป n8n */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  msg.innerHTML = '';

  const fd = new FormData(form);
  const inputs = Array.from(document.querySelectorAll('input[data-ptype]'));
  const rawPhone = String(fd.get('phone')||'');
  const phoneDigits = rawPhone.replace(/\D/g,'');

  const items = inputs.map(el => ({
    product_type: el.dataset.ptype,
    flavor: el.dataset.flavor,
    packs: Number(el.value || 0)
  })).filter(x => x.packs > 0);

  if(items.length === 0){
    msg.innerHTML = '<div class="err">โปรดระบุจำนวนห่ออย่างน้อย 1 รายการ</div>';
    return;
  }

  const payload = {
    first_name: fd.get('first_name') || '',
    last_name: fd.get('last_name') || '',
    address: fd.get('address') || '',
    phone: phoneDigits,
    amount: Number(fd.get('amount')||0),
    payment_method: fd.get('payment_method') || 'TRANSFER',
    shipping: fd.get('shipping') || '',
    social_type: fd.get('social_type') || 'LINE',
    social_name: fd.get('social_name') || '',
    note: fd.get('note') || '',
    items
  };

  btnSubmit.disabled = true; btnSubmit.textContent = 'กำลังส่ง...';
  try{
    const res = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=> ({}));

    if(res.ok && data && data.ok){
      msg.innerHTML = `<div class="ok">บันทึกสำเร็จ! เลขออเดอร์: <b>${data.orderId}</b></div>`;
      form.reset(); updateSummary();
    }else{
      msg.innerHTML = `<div class="err">ส่งไม่สำเร็จ: ${res.status} ${res.statusText} ${data?.message||''}</div>`;
    }
  }catch(err){
    msg.innerHTML = `<div class="err">เกิดข้อผิดพลาดในการเชื่อมต่อ: ${err}</div>`;
  }finally{
    btnSubmit.disabled = false; btnSubmit.textContent = 'ส่งออเดอร์';
  }
});
</script>
</body>
</html>
